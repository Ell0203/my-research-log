---
title: 📊 Stock Screener (이평선 수렴 & RSI 과매도) 개발
date: 2026-02-21
tags: [Python, FinanceDataReader, Google Sheets API, Pandas, 스크리너]
---

**이평선 수렴(Moving Average Convergence)** 패턴과 **RSI 과매도 반등(Oversold Rebound)** 패턴을 순수 기술적 지표로 탐지하여, 그 결과를 구글 스프레드시트에 자동으로 기록하는 다중 주식 스크리너 초기 구성입니다. (Project: `05_stock_screener`)

*   🎯 **Target**: 한국 증시 (KOSPI & KOSDAQ), 시가총액 1,000억 이상 종목
*   📊 **Notification**: Google Sheets 자동 업데이트 (`Stock_screener` 문서)
*   ⏱️ **Schedule**: 로컬 환경 스크립트 실행 (전 종목 순회)

<!-- more -->

## 🏗️ 1. 시스템 아키텍처

이 프로젝트는 현재 두 개의 스크립트로 분리되어, 각기 다른 기술적 분석 전략을 통해 종목을 필터링합니다. 필터링된 결과는 구글 스프레드시트의 각기 다른 탭(`Worksheet`)으로 일괄 업로드됩니다.

### 📈 A. 전략 1: 이평선 수렴 & MACD (`screener_ma.py`)
이평선이 한 곳으로 모이며 에너지가 응집되는 패턴을 찾아내는 기본 스크리너입니다.
*   📐 **이동평균 수렴**: 주가가 최근 횡보하며 5일선, 20일선, 60일선이 아주 좁은 간격(예: 3% 이내)으로 모여 있어야 함.
*   🔥 **거래량 급증**: 최근 영업일 기준 전일 대비 당일 거래량이 2배 이상 폭증해야 함.
*   ✅ **MACD 골든크로스**: MACD 라인이 최근 3일 내에 Signal 라인을 상향 돌파하는 시그널 발생.
*   📋 **구글 시트 출력 탭**: `KOSPI`, `KOSDAQ`

### 📉 B. 전략 2: RSI 과매도 & 볼린저 하단 반등 (`screener_rsi.py`)
"역추세 매매 모델"로, 지나친 하락 후 반등이 시작되는 초입 구간을 잡습니다.
*   📊 **RSI(14)**: 최근 5일 내에 RSI가 30 이하(과매도)로 진입한 후, 현재 시점에서 다시 30 위로 고개를 들어야 함.
*   〰️ **볼린저 밴드(20, 2)**: 최근 5일 내에 종가가 볼린저 하단선 아래로 이탈했다가, 현재 시점에서 다시 밴드 내부(하단선 이상)로 복귀해야 함.
*   📋 **구글 시트 출력 탭**: `RSI_KOSPI`, `RSI_KOSDAQ`

### 🔗 C. 데이터 파이프라인 및 연동 (`gspread` & `FinanceDataReader`)
*   💹 **가격 데이터**: `FinanceDataReader`(`fdr`)를 이용해 130일 치 OHLCV(고저평종, 거래량) 데이터를 종목별 순차적으로 수집.
*   📤 **출력**: `gspread` 라이브러리를 통해 Google Service Account(`credentials.json`)로 인증한 뒤, 지정된 스프레드시트에 DataFrame을 투사.

## 🔧 2. 주요 문제 해결 과정

### 🚫 A. API 차단 (KRX 공식 포털 접근 제한)
초기에는 수급 데이터(외국인, 연기금 무빙) 조회를 위해 한국거래소(KRX) 데이터 포털의 무단(비공식) API를 `requests`로 직접 호출하려 했습니다.
하지만 403 Forbidden 등 봇 차단 방어 로직에 막혔습니다.
*   ❓ **원인**: 브라우저 환경이 아닌 스크립트를 통한 무단 조회 및 세션 토큰 우회를 철저히 차단함.
*   ✅ **해결**: 1단계로는 이를 우회하지 않고 순수 "기술적 지표(이평선, 거래량, RSI, 볼린저)" 기반 스크리너로 노선을 변경함. (이후, 2단계 업그레이드 프로젝트인 Ultimate 버전을 통해 공식 KIS Open API 및 pykrx로 수급을 붙여 해결)

### ⏳ B. 퍼포먼스 및 시총 필터링 속도 개선
전체 상장 종목(약 2,700여 개)을 하나씩 API 호출(`fdr.DataReader()`)할 경우 30분~40분에 육박하는 상당한 소요 시간이 발생했습니다.
*   ✅ **해결1 (초기 적용)**: 시가총액 필터를 500억 -> 1,000억 기준으로 상향 조정하여 불필요한 동전주, 잡주를 배제. 이로써 대상 종목 수를 절반 이하로 줄이고 처리 시간을 최적화.
*   ✅ **해결2 (최종 적용)**: `yfinance` 패키지의 다중 티커 동시 다운로드 기능(Batch request)을 사용하여 분석 소요 시간을 1분 내외로 획기적으로 감축함.

## 📚 3. 배운 점
*   💡 **증권 데이터 수집의 한계**: 무단 웹 크롤링이나 비공식 API는 언제든 차단될 요소를 내포하고 있으므로, 안정적인 일 단위 파이프라인에는 공식 OpenAPI 접근 혹은 `yfinance`/`pykrx` 등 검증된 정제 라이브러리에 의존하는 방향이 강력함.
*   💡 스프레드시트 자동화가 주식 스크리닝 결과를 모니터링하는 데 있어 HTS 구축 대비 생산성이 매우 뛰어남을 확인.
